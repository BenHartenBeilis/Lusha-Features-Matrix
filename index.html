<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lusha Feature Fragmentation Analysis Tool</title>
    <meta name="description" content="Analyze feature fragmentation across Lusha pricing versions with interactive visualizations">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Fallback CDN for PapaParse -->
    <script>
        // Ensure PapaParse is loaded, fallback to alternative CDN if needed
        window.addEventListener('load', function() {
            if (typeof Papa === 'undefined') {
                console.warn('Primary PapaParse CDN failed, loading fallback...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js';
                script.onload = function() {
                    console.log('PapaParse loaded from fallback CDN');
                };
                script.onerror = function() {
                    console.error('Failed to load PapaParse from both CDNs');
                };
                document.head.appendChild(script);
            } else {
                console.log('PapaParse loaded successfully');
            }
        });
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <style>
        .rotate-45 { transform: rotate(-45deg); }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- GitHub Corner -->
    <a href="https://github.com/BenHartenBeilis/Lusha-Features-Matrix" class="github-corner" aria-label="View source on GitHub">
        <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0; z-index: 999;" aria-hidden="true">
            <path d="m0,0 0,250 250,0 0,-250"></path>
            <path d="m128.3,109.0 c113.8,99.7 119.0,89.6 119.0,89.6 0,0 0,0 115.2,-8.6 0,0 84.8,-33.8 84.8,-33.8 0,0 79.2,0 79.2,-79.2 0,0 -33.8,-84.8 -33.8,-84.8 0,0 -8.6,-115.2 -8.6,-115.2 0,0 -89.6,-119.0 -89.6,-119.0 0,0 -99.7,113.8 -99.7,113.8z" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path d="m115.0,115.0 c114.9,67.1 141.9,52.9 141.9,52.9 0,0 18.9,-22.9 18.9,-22.9 0,0 106.9,0.6 106.9,0.6 0,0 84.2,-37.2 84.2,-37.2 0,0 79.8,0 79.8,-79.8 0,0 -37.2,-84.2 -37.2,-84.2 0,0 0.6,-106.9 0.6,-106.9 0,0 -22.9,-18.9 -22.9,-18.9 0,0 52.9,-141.9 52.9,-141.9 0,0 67.1,114.9 67.1,114.9z" fill="currentColor" class="octo-body"></path>
        </svg>
    </a>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const LushaFeatureAnalysis = () => {
            const [data, setData] = useState(null);
            const [selectedVersions, setSelectedVersions] = useState([]);
            const [viewMode, setViewMode] = useState('plan_evolution');
            const [selectedPlan, setSelectedPlan] = useState('');
            const [filterFeatures, setFilterFeatures] = useState('');
            const [loading, setLoading] = useState(true); // Start with loading=true
            const [error, setError] = useState(null);

            // Auto-load data on component mount
            useEffect(() => {
                loadBillingData();
            }, []);
            
            // Data normalization helper function
            const normalizeString = (str) => {
                if (!str || typeof str !== 'string') return str;
                // Trim whitespace and convert to consistent title case
                return str.trim()
                    .toLowerCase()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            };

            // Function to load billing data
            const loadBillingData = async () => {
                try {
                    // Check if Papa (PapaParse) is loaded
                    if (typeof Papa === 'undefined') {
                        console.error('PapaParse library not loaded');
                        setError('CSV parsing library not loaded. Please refresh the page and try again.');
                        return;
                    }

                    setLoading(true);
                    setError(null);
                    console.log('Loading billing data...');
                    
                    const response = await fetch('./billing-server.plans_with_products_good - billing-server.plans_with_products_good.csv');
                    if (!response.ok) {
                        throw new Error(`Failed to load billing data: ${response.status}`);
                    }
                    
                    const csvData = await response.text();
                    console.log('Billing data loaded, processing...');
                    
                    // Use the same processing logic as file upload
                    const parsed = Papa.parse(csvData, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: (header) => header.trim()
                    });
                    
                    // Continue with the same processing logic as handleFileUpload
                    const rows = parsed.data;
                    console.log(`Processing ${rows.length} rows from billing data...`);
                    
                    // Track plan name normalization
                    const planNameChanges = new Map();
                    
                    // Process data structure (same as in handleFileUpload)
                    let structuredData = [];
                    let currentPlan = null;

                    rows.forEach(row => {
                        // Normalize data for consistency
                        const rawPlanName = row.planName || row['Plan Name'];
                        const planName = rawPlanName ? normalizeString(rawPlanName) : null;
                        const pricingVersion = parseFloat(row['Pricing Version'] || row.pricingVersion);
                        const productCode = row.productCode || row['Product Code'];
                        const productName = row.productName || row['Product Name'];

                        // Filter out versions < 2.6
                        if (planName && !isNaN(pricingVersion) && pricingVersion >= 2.6) {
                            const rawPlanCode = row.planCode || row['Plan Code'] || '';
                            const rawPlanDescription = row.planDescription || row['Plan Description'] || '';
                            
                            // Log normalization for debugging
                            if (rawPlanName !== planName) {
                                console.log(`Normalized plan name: "${rawPlanName}" ‚Üí "${planName}"`);
                                if (!planNameChanges.has(rawPlanName)) {
                                    planNameChanges.set(rawPlanName, planName);
                                }
                            }
                            
                            currentPlan = {
                                planName,
                                planCode: rawPlanCode.trim().toLowerCase(), // Normalize to lowercase for codes
                                planDescription: normalizeString(rawPlanDescription),
                                pricingVersion,
                                planActive: row.planActive === 'TRUE' || row.planActive === 'true' || row.planActive === true,
                                features: []
                            };
                            
                            if (productCode) {
                                currentPlan.features.push({
                                    productCode,
                                    productName: productName || productCode
                                });
                            }
                            
                            structuredData.push(currentPlan);
                        } else if (productCode && currentPlan) {
                            currentPlan.features.push({
                                productCode,
                                productName: productName || productCode
                            });
                        }
                    });

                    // Process features and versions (same logic)
                    const allFeatures = new Set();
                    const featuresByVersion = {};
                    const plansByVersion = {};
                    const planEvolution = {};

                    structuredData.forEach(plan => {
                        plan.features.forEach(feature => {
                            allFeatures.add(feature.productCode);
                        });
                        
                        const versionKey = plan.pricingVersion.toString();
                        if (!featuresByVersion[versionKey]) {
                            featuresByVersion[versionKey] = new Set();
                            plansByVersion[versionKey] = new Set();
                        }
                        
                        plansByVersion[versionKey].add(plan.planName);
                        plan.features.forEach(feature => {
                            featuresByVersion[versionKey].add(feature.productCode);
                        });

                        // Track plan evolution
                        if (!planEvolution[plan.planName]) {
                            planEvolution[plan.planName] = {};
                        }
                        planEvolution[plan.planName][versionKey] = plan.features.map(f => f.productCode);
                    });

                    const sortedVersions = Object.keys(featuresByVersion).sort((a, b) => parseFloat(a) - parseFloat(b));
                    const allPlanNames = [...new Set(structuredData.map(plan => plan.planName))].sort();

                    const processedData = {
                        plans: structuredData,
                        allFeatures: Array.from(allFeatures).sort(),
                        allPlanNames,
                        planEvolution,
                        featuresByVersion: Object.fromEntries(
                            Object.entries(featuresByVersion).map(([version, features]) => [
                                version, Array.from(features).sort()
                            ])
                        ),
                        plansByVersion: Object.fromEntries(
                            Object.entries(plansByVersion).map(([version, plans]) => [
                                version, Array.from(plans).sort()
                            ])
                        ),
                        versions: sortedVersions
                    };

                    console.log('Plan name normalization summary:', Array.from(planNameChanges.entries()));
                    console.log('Billing data processed successfully:', {
                        plans: processedData.plans.length,
                        versions: processedData.versions.length,
                        features: processedData.allFeatures.length,
                        planTypes: processedData.allPlanNames.length,
                        planNames: processedData.allPlanNames,
                        planEvolutionKeys: Object.keys(processedData.planEvolution)
                    });
                    
                    // Debug plan normalization
                    console.log('Plan Evolution Keys:', Object.keys(processedData.planEvolution));
                    console.log('All Plan Names:', processedData.allPlanNames);
                    
                    setData(processedData);
                    setSelectedVersions(processedData.versions.slice(-6));
                    if (processedData.allPlanNames.length > 0) {
                        setSelectedPlan(processedData.allPlanNames[0]);
                    }
                    setLoading(false);
                    
                } catch (error) {
                    console.error('Error loading billing data:', error);
                    setError(`Error loading billing data: ${error.message}`);
                    setLoading(false);
                }
            };

            const filteredFeatures = useMemo(() => {
                if (!data) return [];
                return data.allFeatures.filter(feature =>
                    feature.toLowerCase().includes(filterFeatures.toLowerCase())
                );
            }, [data, filterFeatures]);

            const planEvolutionData = useMemo(() => {
                console.log('PlanEvolutionData useMemo triggered:', { selectedPlan, hasData: !!data });
                if (!data || !selectedPlan || !data.planEvolution || !data.planEvolution[selectedPlan]) {
                    console.log('PlanEvolutionData conditions:', {
                        hasData: !!data,
                        hasSelectedPlan: !!selectedPlan,
                        hasPlanEvolution: !!(data?.planEvolution),
                        hasPlanData: !!(data?.planEvolution?.[selectedPlan]),
                        availablePlans: data?.planEvolution ? Object.keys(data.planEvolution) : []
                    });
                    return null;
                }

                const planVersions = data.planEvolution[selectedPlan];
                const versionsWithPlan = Object.keys(planVersions).sort((a, b) => parseFloat(a) - parseFloat(b));
                
                return versionsWithPlan.map(version => ({
                    version,
                    features: planVersions[version] || [],
                    featureMap: Object.fromEntries(
                        filteredFeatures.map(feature => [
                            feature,
                            (planVersions[version] || []).includes(feature)
                        ])
                    )
                }));
            }, [data, selectedPlan, filteredFeatures]);

            const featureMatrix = useMemo(() => {
                if (!data || selectedVersions.length === 0) return null;

                return selectedVersions.map(version => ({
                    version,
                    planCount: data.plansByVersion[version]?.length || 0,
                    features: data.featuresByVersion[version] || [],
                    featureMap: Object.fromEntries(
                        filteredFeatures.map(feature => [
                            feature,
                            (data.featuresByVersion[version] || []).includes(feature)
                        ])
                    )
                }));
            }, [data, selectedVersions, filteredFeatures]);

            // This component now auto-loads data, no need for upload UI

            if (loading) {
                return (
                    <div className="min-h-screen gradient-bg">
                        <div className="container mx-auto px-4 py-16">
                            <div className="text-center text-white mb-12">
                                <h1 className="text-5xl font-bold mb-4">
                                    üîç Lusha Feature Analysis
                                </h1>
                                <p className="text-xl opacity-90">
                                    Analyzing feature fragmentation across pricing versions
                                </p>
                            </div>
                            
                            <div className="max-w-md mx-auto">
                                <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto mb-6"></div>
                                    <div className="text-xl font-semibold text-gray-700 mb-2">Loading Lusha Data...</div>
                                    <div className="text-gray-500">Analyzing pricing plans and feature evolution...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50">
                        <div className="max-w-md mx-auto text-center">
                            <div className="bg-white rounded-lg shadow-lg p-8">
                                <div className="text-6xl mb-4">‚ùå</div>
                                <div className="text-xl font-semibold text-red-600 mb-4">Processing Error</div>
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-left mb-6">
                                    <div className="text-sm text-red-700">{error}</div>
                                </div>
                                <button
                                    onClick={() => {setError(null); setData(null); loadBillingData();}}
                                    className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold"
                                >
                                    Reload Data
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white border-b border-gray-200 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 py-4">
                            <div className="flex items-center justify-between">
                                <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    üîç <span>Lusha Feature Analysis</span>
                                    <span className="text-sm bg-green-100 text-green-700 px-2 py-1 rounded-full font-normal">Full Version</span>
                                </h1>
                                <div className="flex gap-3">
                                    <div className="text-sm text-green-600 bg-green-50 px-3 py-2 rounded-full font-medium">
                                        ‚úÖ {data.plans.length} Plans ‚Ä¢ {data.versions.length} Versions
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 py-6">
                        {/* Quick Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                                <div className="text-3xl font-bold text-blue-600">{data.versions.length}</div>
                                <div className="text-sm text-blue-700 font-medium">Versions (‚â•2.6)</div>
                            </div>
                            <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                                <div className="text-3xl font-bold text-green-600">{data.allPlanNames.length}</div>
                                <div className="text-sm text-green-700 font-medium">Plan Types</div>
                            </div>
                            <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                                <div className="text-3xl font-bold text-purple-600">{data.allFeatures.length}</div>
                                <div className="text-sm text-purple-700 font-medium">Total Features</div>
                            </div>
                            <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl border border-orange-200">
                                <div className="text-3xl font-bold text-orange-600">{data.plans.length}</div>
                                <div className="text-sm text-orange-700 font-medium">Plan Configs</div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-3">
                                        üìä Analysis Mode
                                    </label>
                                    <select
                                        value={viewMode}
                                        onChange={(e) => setViewMode(e.target.value)}
                                        className="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium"
                                    >
                                        <option value="plan_evolution">üîÑ Plan Evolution</option>
                                        <option value="matrix">üìã Feature Matrix</option>
                                        <option value="evolution">üìà Version Timeline</option>
                                        <option value="comparison">üîÑ Version Comparison</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-3">
                                        üéØ Select Plan {viewMode === 'plan_evolution' && <span className="text-blue-600">(Required)</span>}
                                    </label>
                                    <select
                                        value={selectedPlan}
                                        onChange={(e) => {
                                            console.log('Plan selection changed:', e.target.value);
                                            setSelectedPlan(e.target.value);
                                        }}
                                        className={`w-full p-3 border-2 rounded-lg focus:ring-2 focus:ring-blue-500 font-medium ${
                                            viewMode === 'plan_evolution' 
                                                ? 'border-blue-300 bg-blue-50' 
                                                : 'border-gray-200'
                                        }`}
                                    >
                                        <option value="">Choose a plan...</option>
                                        {data.allPlanNames.map(plan => (
                                            <option key={plan} value={plan}>{plan}</option>
                                        ))}
                                    </select>
                                </div>
                                
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-3">
                                        üîç Filter Features ({filteredFeatures.length})
                                    </label>
                                    <input
                                        type="text"
                                        value={filterFeatures}
                                        onChange={(e) => setFilterFeatures(e.target.value)}
                                        placeholder="Search features..."
                                        className="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                            </div>

                            {viewMode !== 'plan_evolution' && (
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-3">
                                        üéØ Version Selection ({selectedVersions.length} selected)
                                    </label>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setSelectedVersions(data.versions.slice(-5))}
                                            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
                                        >
                                            Latest 5
                                        </button>
                                        <button
                                            onClick={() => setSelectedVersions(data.versions.slice(-10))}
                                            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
                                        >
                                            Latest 10
                                        </button>
                                        <button
                                            onClick={() => setSelectedVersions(data.versions)}
                                            className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium"
                                        >
                                            All ({data.versions.length})
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Plan Evolution View */}
                        {viewMode === 'plan_evolution' && (
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                {!selectedPlan ? (
                                    <div className="text-center py-16 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                                        <div className="text-6xl mb-4">üìã</div>
                                        <div className="text-2xl font-bold text-yellow-800 mb-2">Select a Plan to Analyze</div>
                                        <div className="text-yellow-700">Choose a plan from the dropdown above to see how its features evolved across pricing versions.</div>
                                    </div>
                                ) : !planEvolutionData || planEvolutionData.length === 0 ? (
                                    <div className="text-center py-16 bg-gradient-to-br from-red-50 to-pink-50 rounded-xl border border-red-200">
                                        <div className="text-6xl mb-4">‚ùå</div>
                                        <div className="text-2xl font-bold text-red-800 mb-2">No Data Found</div>
                                        <div className="text-red-700">Plan "{selectedPlan}" was not found in versions ‚â• 2.6</div>
                                    </div>
                                ) : (
                                    <>
                                        <div className="mb-6">
                                            <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-3 mb-4">
                                                üîÑ <span>Plan Evolution:</span> 
                                                <span className="text-blue-600">"{selectedPlan}"</span>
                                                <span className="text-sm font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                                    {planEvolutionData.length} versions
                                                </span>
                                            </h2>

                                            {/* Evolution Stats */}
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                                                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200 text-center">
                                                    <div className="text-2xl font-bold text-blue-600">{planEvolutionData.length}</div>
                                                    <div className="text-xs text-blue-700 font-medium">Versions</div>
                                                </div>
                                                <div className="bg-green-50 p-4 rounded-lg border border-green-200 text-center">
                                                    <div className="text-2xl font-bold text-green-600">
                                                        {Math.max(...planEvolutionData.map(p => p.features.length))}
                                                    </div>
                                                    <div className="text-xs text-green-700 font-medium">Max Features</div>
                                                </div>
                                                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200 text-center">
                                                    <div className="text-2xl font-bold text-purple-600">
                                                        {Math.min(...planEvolutionData.map(p => p.features.length))}
                                                    </div>
                                                    <div className="text-xs text-purple-700 font-medium">Min Features</div>
                                                </div>
                                                <div className="bg-orange-50 p-4 rounded-lg border border-orange-200 text-center">
                                                    <div className="text-2xl font-bold text-orange-600">
                                                        {new Set(planEvolutionData.flatMap(p => p.features)).size}
                                                    </div>
                                                    <div className="text-xs text-orange-700 font-medium">Total Unique</div>
                                                </div>
                                            </div>
                                        </div>

                                        {filteredFeatures.length === 0 ? (
                                            <div className="text-center py-12 text-gray-500 bg-gray-50 rounded-lg">
                                                <div className="text-4xl mb-2">üîç</div>
                                                <div>No features match your filter. Try a broader search term.</div>
                                            </div>
                                        ) : (
                                            <>
                                                <div className="overflow-x-auto border rounded-xl shadow-sm">
                                                    <table className="min-w-full bg-white">
                                                        <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
                                                            <tr>
                                                                <th className="sticky left-0 bg-gray-50 px-6 py-4 text-left font-bold text-gray-800 border-r border-gray-200">Version</th>
                                                                <th className="px-4 py-4 text-center font-bold text-gray-800 border-r border-gray-200">Features</th>
                                                                <th className="px-4 py-4 text-center font-bold text-gray-800 border-r border-gray-200">Change</th>
                                                                {filteredFeatures.slice(0, 12).map(feature => (
                                                                    <th key={feature} className="px-3 py-4 text-center font-semibold text-gray-700 border-r border-gray-200 min-w-[70px]" title={feature}>
                                                                        <div className="rotate-45 whitespace-nowrap text-xs">
                                                                            {feature.length > 8 ? `${feature.substring(0, 8)}...` : feature}
                                                                        </div>
                                                                    </th>
                                                                ))}
                                                                {filteredFeatures.length > 12 && (
                                                                    <th className="px-4 py-4 text-center text-gray-500 font-semibold">+{filteredFeatures.length - 12} more</th>
                                                                )}
                                                            </tr>
                                                        </thead>
                                                        <tbody className="divide-y divide-gray-100">
                                                            {planEvolutionData.map((versionData, index) => {
                                                                const prevVersion = index > 0 ? planEvolutionData[index - 1] : null;
                                                                const change = prevVersion ? versionData.features.length - prevVersion.features.length : 0;
                                                                
                                                                return (
                                                                    <tr key={versionData.version} className="hover:bg-blue-50 transition-colors">
                                                                        <td className="sticky left-0 bg-white hover:bg-blue-50 px-6 py-4 font-bold text-gray-800 border-r border-gray-200">
                                                                            v{versionData.version}
                                                                        </td>
                                                                        <td className="px-4 py-4 text-center border-r border-gray-200 font-bold text-lg">
                                                                            {versionData.features.length}
                                                                        </td>
                                                                        <td className="px-4 py-4 text-center border-r border-gray-200">
                                                                            {change !== 0 && (
                                                                                <span className={`px-3 py-1 rounded-full text-sm font-bold ${change > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                                                                                    {change > 0 ? '+' : ''}{change}
                                                                                </span>
                                                                            )}
                                                                        </td>
                                                                        {filteredFeatures.slice(0, 12).map(feature => {
                                                                            const hasFeature = versionData.featureMap[feature];
                                                                            const prevHadFeature = prevVersion?.featureMap[feature] || false;
                                                                            
                                                                            let cellClass = 'px-3 py-4 text-center border-r border-gray-200 ';
                                                                            if (hasFeature && !prevHadFeature) {
                                                                                cellClass += 'bg-green-200 text-green-900';
                                                                            } else if (!hasFeature && prevHadFeature) {
                                                                                cellClass += 'bg-red-200 text-red-900';
                                                                            } else if (hasFeature) {
                                                                                cellClass += 'bg-green-100 text-green-800';
                                                                            } else {
                                                                                cellClass += 'bg-gray-50 text-gray-400';
                                                                            }

                                                                            return (
                                                                                <td key={feature} className={cellClass}>
                                                                                    <div className="font-bold text-xl">
                                                                                        {hasFeature ? '‚úì' : '‚Äî'}
                                                                                    </div>
                                                                                    {hasFeature && !prevHadFeature && <div className="text-xs font-bold text-green-900">NEW</div>}
                                                                                    {!hasFeature && prevHadFeature && <div className="text-xs font-bold text-red-900">DEL</div>}
                                                                                </td>
                                                                            );
                                                                        })}
                                                                        {filteredFeatures.length > 12 && (
                                                                            <td className="px-4 py-4 text-center text-gray-600 font-semibold">
                                                                                {versionData.features.filter(f => filteredFeatures.includes(f)).length}
                                                                            </td>
                                                                        )}
                                                                    </tr>
                                                                );
                                                            })}
                                                        </tbody>
                                                    </table>
                                                </div>

                                                {/* Legend */}
                                                <div className="mt-6 flex flex-wrap gap-6 justify-center">
                                                    <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg border border-green-200">
                                                        <div className="w-4 h-4 bg-green-200 rounded"></div>
                                                        <span className="font-medium text-green-800">Added in this version</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 bg-red-50 px-4 py-2 rounded-lg border border-red-200">
                                                        <div className="w-4 h-4 bg-red-200 rounded"></div>
                                                        <span className="font-medium text-red-800">Removed in this version</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 bg-green-50 px-4 py-2 rounded-lg border border-green-200">
                                                        <div className="w-4 h-4 bg-green-100 rounded"></div>
                                                        <span className="font-medium text-green-700">Existing feature</span>
                                                    </div>
                                                    <div className="flex items-center gap-2 bg-gray-50 px-4 py-2 rounded-lg border border-gray-200">
                                                        <div className="w-4 h-4 bg-gray-100 rounded"></div>
                                                        <span className="font-medium text-gray-600">Not present</span>
                                                    </div>
                                                </div>
                                            </>
                                        )}
                                    </>
                                )}
                            </div>
                        )}

                        {/* Feature Matrix View */}
                        {viewMode === 'matrix' && (
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <div className="mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-3 mb-4">
                                        üìã <span>Feature Matrix:</span> 
                                        <span className="text-blue-600">Cross-Version Analysis</span>
                                        <span className="text-sm font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                            {selectedVersions.length} versions ‚Ä¢ {filteredFeatures.length} features
                                        </span>
                                    </h2>
                                </div>

                                {filteredFeatures.length === 0 ? (
                                    <div className="text-center py-12 text-gray-500 bg-gray-50 rounded-lg">
                                        <div className="text-4xl mb-2">üîç</div>
                                        <div>No features match your filter. Try a broader search term.</div>
                                    </div>
                                ) : featureMatrix && featureMatrix.length > 0 ? (
                                    <div className="overflow-x-auto border rounded-xl shadow-sm">
                                        <table className="min-w-full bg-white">
                                            <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
                                                <tr>
                                                    <th className="sticky left-0 bg-gray-50 px-6 py-4 text-left font-bold text-gray-800 border-r border-gray-200">Feature</th>
                                                    {featureMatrix.map(versionData => (
                                                        <th key={versionData.version} className="px-4 py-4 text-center font-bold text-gray-800 border-r border-gray-200 min-w-[100px]">
                                                            <div className="text-lg">v{versionData.version}</div>
                                                            <div className="text-xs text-gray-600 font-normal">{versionData.planCount} plans</div>
                                                        </th>
                                                    ))}
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {filteredFeatures.map(feature => (
                                                    <tr key={feature} className="hover:bg-blue-50 transition-colors">
                                                        <td className="sticky left-0 bg-white hover:bg-blue-50 px-6 py-4 font-semibold text-gray-800 border-r border-gray-200 min-w-[200px]">
                                                            <div className="text-sm">{feature}</div>
                                                        </td>
                                                        {featureMatrix.map(versionData => {
                                                            const hasFeature = versionData.featureMap[feature];
                                                            return (
                                                                <td key={versionData.version} className={`px-4 py-4 text-center border-r border-gray-200 ${
                                                                    hasFeature ? 'bg-green-100 text-green-800' : 'bg-gray-50 text-gray-400'
                                                                }`}>
                                                                    <div className="font-bold text-xl">
                                                                        {hasFeature ? '‚úì' : '‚Äî'}
                                                                    </div>
                                                                </td>
                                                            );
                                                        })}
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                ) : (
                                    <div className="text-center py-16 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                                        <div className="text-6xl mb-4">üìä</div>
                                        <div className="text-2xl font-bold text-yellow-800 mb-2">Select Versions to Compare</div>
                                        <div className="text-yellow-700">Choose versions from the controls above to see the feature matrix.</div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Version Timeline View */}
                        {viewMode === 'evolution' && (
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <div className="mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-3 mb-4">
                                        üìà <span>Version Timeline:</span> 
                                        <span className="text-blue-600">Feature Evolution Overview</span>
                                    </h2>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {data.versions.map(version => {
                                        const versionFeatures = data.featuresByVersion[version] || [];
                                        const versionPlans = data.plansByVersion[version] || [];
                                        return (
                                            <div key={version} className="bg-gradient-to-br from-blue-50 to-purple-50 p-6 rounded-xl border border-blue-200 hover:shadow-lg transition-shadow">
                                                <div className="text-center mb-4">
                                                    <div className="text-2xl font-bold text-blue-600 mb-1">v{version}</div>
                                                    <div className="text-sm text-gray-600">Pricing Version</div>
                                                </div>
                                                
                                                <div className="space-y-3">
                                                    <div className="bg-white p-3 rounded-lg">
                                                        <div className="text-lg font-semibold text-green-600">{versionFeatures.length}</div>
                                                        <div className="text-xs text-gray-600">Features</div>
                                                    </div>
                                                    
                                                    <div className="bg-white p-3 rounded-lg">
                                                        <div className="text-lg font-semibold text-purple-600">{versionPlans.length}</div>
                                                        <div className="text-xs text-gray-600">Plans</div>
                                                    </div>
                                                    
                                                    <div className="bg-white p-3 rounded-lg">
                                                        <div className="text-xs text-gray-600 font-medium mb-1">Top Plans:</div>
                                                        <div className="text-sm text-gray-800">
                                                            {versionPlans.slice(0, 3).map((plan, idx) => (
                                                                <div key={plan} className="truncate">
                                                                    {idx + 1}. {plan}
                                                                </div>
                                                            ))}
                                                            {versionPlans.length > 3 && (
                                                                <div className="text-gray-500">+{versionPlans.length - 3} more</div>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {/* Version Comparison View */}
                        {viewMode === 'comparison' && (
                            <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                                <div className="mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-3 mb-4">
                                        üîÑ <span>Version Comparison:</span> 
                                        <span className="text-blue-600">Side-by-Side Analysis</span>
                                    </h2>
                                </div>

                                {selectedVersions.length < 2 ? (
                                    <div className="text-center py-16 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                                        <div className="text-6xl mb-4">‚öñÔ∏è</div>
                                        <div className="text-2xl font-bold text-yellow-800 mb-2">Select 2+ Versions to Compare</div>
                                        <div className="text-yellow-700">Choose multiple versions from the controls above to see detailed comparisons.</div>
                                    </div>
                                ) : (
                                    <div className="space-y-8">
                                        {/* Comparison Summary */}
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                            <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                                                <div className="text-3xl font-bold text-green-600">
                                                    {Math.max(...selectedVersions.map(v => (data.featuresByVersion[v] || []).length))}
                                                </div>
                                                <div className="text-sm text-green-700 font-medium">Max Features</div>
                                            </div>
                                            <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                                                <div className="text-3xl font-bold text-blue-600">
                                                    {Math.min(...selectedVersions.map(v => (data.featuresByVersion[v] || []).length))}
                                                </div>
                                                <div className="text-sm text-blue-700 font-medium">Min Features</div>
                                            </div>
                                            <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                                                <div className="text-3xl font-bold text-purple-600">
                                                    {new Set(selectedVersions.flatMap(v => data.featuresByVersion[v] || [])).size}
                                                </div>
                                                <div className="text-sm text-purple-700 font-medium">Unique Features</div>
                                            </div>
                                        </div>

                                        {/* Detailed Comparison Table */}
                                        <div className="overflow-x-auto border rounded-xl shadow-sm">
                                            <table className="min-w-full bg-white">
                                                <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
                                                    <tr>
                                                        <th className="sticky left-0 bg-gray-50 px-6 py-4 text-left font-bold text-gray-800 border-r border-gray-200">Metric</th>
                                                        {selectedVersions.map(version => (
                                                            <th key={version} className="px-4 py-4 text-center font-bold text-gray-800 border-r border-gray-200 min-w-[120px]">
                                                                v{version}
                                                            </th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    <tr className="hover:bg-blue-50">
                                                        <td className="sticky left-0 bg-white hover:bg-blue-50 px-6 py-4 font-semibold text-gray-800 border-r border-gray-200">
                                                            Total Features
                                                        </td>
                                                        {selectedVersions.map(version => (
                                                            <td key={version} className="px-4 py-4 text-center border-r border-gray-200 font-bold text-lg">
                                                                {(data.featuresByVersion[version] || []).length}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                    <tr className="hover:bg-blue-50">
                                                        <td className="sticky left-0 bg-white hover:bg-blue-50 px-6 py-4 font-semibold text-gray-800 border-r border-gray-200">
                                                            Total Plans
                                                        </td>
                                                        {selectedVersions.map(version => (
                                                            <td key={version} className="px-4 py-4 text-center border-r border-gray-200 font-bold text-lg">
                                                                {(data.plansByVersion[version] || []).length}
                                                            </td>
                                                        ))}
                                                    </tr>
                                                    <tr className="hover:bg-blue-50">
                                                        <td className="sticky left-0 bg-white hover:bg-blue-50 px-6 py-4 font-semibold text-gray-800 border-r border-gray-200">
                                                            Available Plans
                                                        </td>
                                                        {selectedVersions.map(version => (
                                                            <td key={version} className="px-4 py-4 text-center border-r border-gray-200">
                                                                <div className="text-xs space-y-1">
                                                                    {(data.plansByVersion[version] || []).map(plan => (
                                                                        <div key={plan} className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">
                                                                            {plan}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </td>
                                                        ))}
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LushaFeatureAnalysis />);
    </script>
</body>
</html>