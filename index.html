<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lusha Internal Tool</title>
    <meta name="description" content="Internal Lusha tool - access restricted">
    <meta name="cache-control" content="no-cache, no-store, must-revalidate">
    <meta name="pragma" content="no-cache">
    <meta name="expires" content="0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Prevent search engine indexing and discovery -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta name="googlebot" content="noindex, nofollow">
    <meta name="bingbot" content="noindex, nofollow">
    <meta name="slurp" content="noindex, nofollow">
    <meta name="duckduckbot" content="noindex, nofollow">
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🔒</text></svg>">
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    
    <!-- Google OAuth -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- Fallback CDN for PapaParse -->
    <script>
        // Ensure PapaParse is loaded, fallback to alternative CDN if needed
        window.addEventListener('load', function() {
            if (typeof Papa === 'undefined') {
                console.warn('Primary PapaParse CDN failed, loading fallback...');
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js';
                script.onload = function() {
                    console.log('PapaParse loaded from fallback CDN');
                };
                script.onerror = function() {
                    console.error('Failed to load PapaParse from both CDNs');
                };
                document.head.appendChild(script);
            } else {
                console.log('PapaParse loaded successfully');
            }
        });
    </script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <style>
        .rotate-45 { transform: rotate(-45deg); }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- GitHub Corner -->
    <a href="https://github.com/BenHartenBeilis/Lusha-Features-Matrix" class="github-corner" aria-label="View source on GitHub">
        <svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0; z-index: 999;" aria-hidden="true">
            <path d="m0,0 0,250 250,0 0,-250"></path>
            <path d="m128.3,109.0 c113.8,99.7 119.0,89.6 119.0,89.6 0,0 0,0 115.2,-8.6 0,0 84.8,-33.8 84.8,-33.8 0,0 79.2,0 79.2,-79.2 0,0 -33.8,-84.8 -33.8,-84.8 0,0 -8.6,-115.2 -8.6,-115.2 0,0 -89.6,-119.0 -89.6,-119.0 0,0 -99.7,113.8 -99.7,113.8z" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
            <path d="m115.0,115.0 c114.9,67.1 141.9,52.9 141.9,52.9 0,0 18.9,-22.9 18.9,-22.9 0,0 106.9,0.6 106.9,0.6 0,0 84.2,-37.2 84.2,-37.2 0,0 79.8,0 79.8,-79.8 0,0 -37.2,-84.2 -37.2,-84.2 0,0 0.6,-106.9 0.6,-106.9 0,0 -22.9,-18.9 -22.9,-18.9 0,0 52.9,-141.9 52.9,-141.9 0,0 67.1,114.9 67.1,114.9z" fill="currentColor" class="octo-body"></path>
        </svg>
    </a>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const LushaFeatureAnalysis = () => {
            const [data, setData] = useState(null);
            const [selectedVersions, setSelectedVersions] = useState([]);
            const [viewMode, setViewMode] = useState('featureMatrix'); // 'featureMatrix' or 'planComparison'
            const [selectedVersion, setSelectedVersion] = useState(''); // For plan comparison view
            const [selectedPlan, setSelectedPlan] = useState('');
            const [filterFeatures, setFilterFeatures] = useState('');
            const [loading, setLoading] = useState(true); // Start with loading=true
            const [error, setError] = useState(null);
            
            // Authentication state - TEMPORARILY DISABLED for immediate access
            // TODO: Re-enable when Google OAuth Client ID is configured
            const [isAuthenticated, setIsAuthenticated] = useState(true); // Changed to true for temp access
            const [user, setUser] = useState({
                name: "Lusha Employee", 
                email: "employee@lusha.com", 
                picture: null
            }); // Temporary user for testing
            const [authLoading, setAuthLoading] = useState(false); // Changed to false to skip auth loading

            /* ========== OAUTH AUTHENTICATION CODE - TEMPORARILY DISABLED ==========
             * 
             * To re-enable authentication:
             * 1. Get Google OAuth Client ID from https://console.cloud.google.com/
             * 2. Replace "YOUR_GOOGLE_CLIENT_ID_HERE" with actual client ID
             * 3. Set isAuthenticated to useState(false) above
             * 4. Set authLoading to useState(true) above  
             * 5. Set user to useState(null) above
             * 6. Uncomment this useEffect and the auth screens below
             */
            
            // Google OAuth configuration
            const GOOGLE_CLIENT_ID = "YOUR_GOOGLE_CLIENT_ID_HERE"; // Replace with actual client ID
            
            // Initialize Google OAuth - COMMENTED OUT FOR TEMP ACCESS
            /*
            useEffect(() => {
                if (typeof google !== 'undefined') {
                    google.accounts.id.initialize({
                        client_id: GOOGLE_CLIENT_ID,
                        callback: handleCredentialResponse,
                        auto_select: false,
                        cancel_on_tap_outside: false,
                    });
                    setAuthLoading(false);
                } else {
                    // Wait for Google script to load
                    const checkGoogle = setInterval(() => {
                        if (typeof google !== 'undefined') {
                            google.accounts.id.initialize({
                                client_id: GOOGLE_CLIENT_ID,
                                callback: handleCredentialResponse,
                                auto_select: false,
                                cancel_on_tap_outside: false,
                            });
                            setAuthLoading(false);
                            clearInterval(checkGoogle);
                        }
                    }, 100);
                    
                    // Cleanup after 10 seconds
                    setTimeout(() => clearInterval(checkGoogle), 10000);
                }
            }, []);
            */

            // Auto-load data when authenticated (or immediately for temp access)
            useEffect(() => {
                // Since auth is disabled, load data immediately
                loadBillingData();
            }, []); // Removed isAuthenticated dependency for temp access
            
            /* ========== OAUTH HANDLER FUNCTIONS - TEMPORARILY DISABLED ==========
             * These functions are preserved for when OAuth is re-enabled
             */
            
            // Handle Google OAuth response - COMMENTED OUT FOR TEMP ACCESS
            /*
            const handleCredentialResponse = (response) => {
                try {
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    console.log('OAuth payload:', payload);
                    
                    // Validate Lusha domain
                    if (!payload.email || !payload.email.endsWith('@lusha.com')) {
                        setError('Access restricted to Lusha employees only. Please use your @lusha.com email address.');
                        return;
                    }
                    
                    // Set authenticated user
                    setUser({
                        name: payload.name,
                        email: payload.email,
                        picture: payload.picture
                    });
                    setIsAuthenticated(true);
                    setError(null);
                    
                    console.log('Authenticated Lusha user:', payload.email);
                    
                } catch (error) {
                    console.error('Error processing authentication:', error);
                    setError('Authentication failed. Please try again.');
                }
            };
            */
            
            // Sign out function - SIMPLIFIED FOR TEMP ACCESS
            const handleSignOut = () => {
                // For temp access, just reload the page
                window.location.reload();
                /* Original OAuth sign out - uncomment when re-enabling OAuth:
                google.accounts.id.disableAutoSelect();
                setIsAuthenticated(false);
                setUser(null);
                setData(null);
                setLoading(true);
                */
            };
            
            // Data normalization helper function
            const normalizeString = (str) => {
                if (!str || typeof str !== 'string') return str;
                // Trim whitespace and convert to consistent title case
                return str.trim()
                    .toLowerCase()
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            };

            // Function to load billing data
            const loadBillingData = async () => {
                try {
                    // Check if Papa (PapaParse) is loaded
                    if (typeof Papa === 'undefined') {
                        console.error('PapaParse library not loaded');
                        setError('CSV parsing library not loaded. Please refresh the page and try again.');
                        return;
                    }

                    setLoading(true);
                    setError(null);
                    console.log('Loading billing data...');
                    
                    const response = await fetch('./billing-data.csv');
                    if (!response.ok) {
                        throw new Error(`Failed to load billing data: ${response.status}`);
                    }
                    
                    const csvData = await response.text();
                    console.log('Billing data loaded, processing...');
                    
                    // Use the same processing logic as file upload
                    const parsed = Papa.parse(csvData, {
                        header: true,
                        skipEmptyLines: true,
                        transformHeader: (header) => header.trim()
                    });
                    
                    // Continue with the same processing logic as handleFileUpload
                    const rows = parsed.data;
                    console.log(`Processing ${rows.length} rows from billing data...`);
                    
                    // Track plan name normalization
                    const planNameChanges = new Map();
                    
                    // Process data structure (same as in handleFileUpload)
                    let structuredData = [];
                    let currentPlan = null;

                    rows.forEach(row => {
                        // Normalize data for consistency
                        const rawPlanName = row.planName || row['Plan Name'];
                        const planName = rawPlanName ? normalizeString(rawPlanName) : null;
                        const pricingVersion = parseFloat(row['Pricing Version'] || row.pricingVersion);
                        const productCode = row.productCode || row['Product Code'];
                        const productName = row.productName || row['Product Name'];

                        // Filter out versions < 2.6
                        if (planName && !isNaN(pricingVersion) && pricingVersion >= 2.6) {
                            const rawPlanCode = row.planCode || row['Plan Code'] || '';
                            const rawPlanDescription = row.planDescription || row['Plan Description'] || '';
                            
                            // Log normalization for debugging
                            if (rawPlanName !== planName) {
                                console.log(`Normalized plan name: "${rawPlanName}" → "${planName}"`);
                                if (!planNameChanges.has(rawPlanName)) {
                                    planNameChanges.set(rawPlanName, planName);
                                }
                            }
                            
                            currentPlan = {
                                planName,
                                planCode: rawPlanCode.trim().toLowerCase(), // Normalize to lowercase for codes
                                planDescription: normalizeString(rawPlanDescription),
                                pricingVersion,
                                planActive: row.planActive === 'TRUE' || row.planActive === 'true' || row.planActive === true,
                                features: []
                            };
                            
                            if (productCode) {
                                currentPlan.features.push({
                                    productCode,
                                    productName: productName || productCode
                                });
                            }
                            
                            structuredData.push(currentPlan);
                        } else if (productCode && currentPlan) {
                            currentPlan.features.push({
                                productCode,
                                productName: productName || productCode
                            });
                        }
                    });

                    // Process features and versions (same logic)
                    const allFeatures = new Set();
                    const featuresByVersion = {};
                    const plansByVersion = {};
                    const planEvolution = {};

                    structuredData.forEach(plan => {
                        plan.features.forEach(feature => {
                            allFeatures.add(feature.productCode);
                        });
                        
                        const versionKey = plan.pricingVersion.toString();
                        if (!featuresByVersion[versionKey]) {
                            featuresByVersion[versionKey] = new Set();
                            plansByVersion[versionKey] = new Set();
                        }
                        
                        plansByVersion[versionKey].add(plan.planName);
                        plan.features.forEach(feature => {
                            featuresByVersion[versionKey].add(feature.productCode);
                        });

                        // Track plan evolution
                        if (!planEvolution[plan.planName]) {
                            planEvolution[plan.planName] = {};
                        }
                        planEvolution[plan.planName][versionKey] = plan.features.map(f => f.productCode);
                    });

                    const sortedVersions = Object.keys(featuresByVersion).sort((a, b) => parseFloat(a) - parseFloat(b));
                    const allPlanNames = [...new Set(structuredData.map(plan => plan.planName))].sort();

                    const processedData = {
                        plans: structuredData,
                        allFeatures: Array.from(allFeatures).sort(),
                        allPlanNames,
                        planEvolution,
                        featuresByVersion: Object.fromEntries(
                            Object.entries(featuresByVersion).map(([version, features]) => [
                                version, Array.from(features).sort()
                            ])
                        ),
                        plansByVersion: Object.fromEntries(
                            Object.entries(plansByVersion).map(([version, plans]) => [
                                version, Array.from(plans).sort()
                            ])
                        ),
                        versions: sortedVersions
                    };

                    console.log('Plan name normalization summary:', Array.from(planNameChanges.entries()));
                    console.log('Billing data processed successfully:', {
                        plans: processedData.plans.length,
                        versions: processedData.versions.length,
                        features: processedData.allFeatures.length,
                        planTypes: processedData.allPlanNames.length,
                        planNames: processedData.allPlanNames,
                        planEvolutionKeys: Object.keys(processedData.planEvolution)
                    });
                    
                    // Debug plan normalization
                    console.log('Plan Evolution Keys:', Object.keys(processedData.planEvolution));
                    console.log('All Plan Names:', processedData.allPlanNames);
                    
                    setData(processedData);
                    setSelectedVersions(processedData.versions.slice(-6));
                    if (processedData.allPlanNames.length > 0) {
                        setSelectedPlan(processedData.allPlanNames[0]);
                    }
                    setLoading(false);
                    
                } catch (error) {
                    console.error('Error loading billing data:', error);
                    setError(`Error loading billing data: ${error.message}`);
                    setLoading(false);
                }
            };

            const filteredFeatures = useMemo(() => {
                if (!data) return [];
                return data.allFeatures.filter(feature =>
                    feature.toLowerCase().includes(filterFeatures.toLowerCase())
                );
            }, [data, filterFeatures]);

            // Removed planEvolutionData - only Feature Matrix view remains

            const featureMatrix = useMemo(() => {
                
                if (!data || selectedVersions.length === 0) return null;

                // If no plan is selected, show all features across versions (original behavior)
                if (!selectedPlan) {
                    return selectedVersions.map(version => ({
                        version,
                        planCount: data.plansByVersion[version]?.length || 0,
                        features: data.featuresByVersion[version] || [],
                        featureMap: Object.fromEntries(
                            filteredFeatures.map(feature => [
                                feature,
                                (data.featuresByVersion[version] || []).includes(feature)
                            ])
                        )
                    }));
                }

                // If a plan is selected, show features for that specific plan across versions
                return selectedVersions.map(version => {
                    // Get features for the selected plan in this version
                    const planFeaturesInVersion = data.planEvolution[selectedPlan]?.[version] || [];
                    
                    return {
                        version,
                        planCount: data.plansByVersion[version]?.length || 0,
                        features: planFeaturesInVersion,
                        featureMap: Object.fromEntries(
                            filteredFeatures.map(feature => [
                                feature,
                                planFeaturesInVersion.includes(feature)
                            ])
                        )
                    };
                });
            }, [data, selectedVersions, filteredFeatures, selectedPlan]);

            // Plan Comparison Matrix - shows features across plans for a single version
            const planComparisonMatrix = useMemo(() => {
                if (!data || !selectedVersion) return null;

                // Get all plans available in the selected version
                const plansInVersion = data.plansByVersion[selectedVersion] || [];
                
                // Create feature map for each plan in the selected version
                const planFeatureMap = {};
                plansInVersion.forEach(planName => {
                    const planFeaturesInVersion = data.planEvolution[planName]?.[selectedVersion] || [];
                    planFeatureMap[planName] = planFeaturesInVersion;
                });

                return {
                    version: selectedVersion,
                    plans: plansInVersion,
                    planFeatureMap,
                    featureMap: Object.fromEntries(
                        filteredFeatures.map(feature => [
                            feature,
                            Object.fromEntries(
                                plansInVersion.map(plan => [
                                    plan,
                                    (planFeatureMap[plan] || []).includes(feature)
                                ])
                            )
                        ])
                    )
                };
            }, [data, selectedVersion, filteredFeatures]);

            /* ========== AUTHENTICATION SCREENS - TEMPORARILY DISABLED ==========
             * Uncomment these sections when re-enabling OAuth authentication
             */
            
            // Authentication loading screen - COMMENTED OUT FOR TEMP ACCESS
            /*
            if (authLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto mb-4"></div>
                            <div className="text-xl font-semibold text-gray-700 mb-2">Initializing Authentication...</div>
                            <div className="text-gray-500">Setting up secure access...</div>
                        </div>
                    </div>
                );
            }

            // Login screen for unauthenticated users - COMMENTED OUT FOR TEMP ACCESS
            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen gradient-bg">
                        <div className="container mx-auto px-4 py-16">
                            <div className="text-center text-white mb-12">
                                <h1 className="text-5xl font-bold mb-4">
                                    🔒 Lusha Internal Tool
                                </h1>
                                <p className="text-xl opacity-90">
                                    Access restricted to Lusha employees
                                </p>
                            </div>
                            
                            <div className="max-w-md mx-auto">
                                <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                    <div className="text-6xl mb-6">🏢</div>
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                        Lusha Employee Access
                                    </h2>
                                    <p className="text-gray-600 mb-6">
                                        Please sign in with your Lusha Google account to access the Feature Analysis Tool.
                                    </p>
                                    
                                    {error && (
                                        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                                            <div className="text-sm text-red-700">{error}</div>
                                        </div>
                                    )}
                                    
                                    <div id="google-signin-button" className="mb-6"></div>
                                    
                                    {GOOGLE_CLIENT_ID === "YOUR_GOOGLE_CLIENT_ID_HERE" && (
                                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-left">
                                            <div className="text-sm text-yellow-800">
                                                <strong>Setup Required:</strong> Google OAuth client ID not configured. 
                                                Please replace the placeholder in the code with your actual Google OAuth client ID.
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }
            */

            // Data loading screen for authenticated users
            if (loading) {
                return (
                    <div className="min-h-screen gradient-bg">
                        <div className="container mx-auto px-4 py-16">
                            <div className="text-center text-white mb-12">
                                <h1 className="text-5xl font-bold mb-4">
                                    🔍 Lusha Feature Analysis
                                </h1>
                                <p className="text-xl opacity-90">
                                    Analyzing feature fragmentation across pricing versions
                                </p>
                            </div>
                            
                            <div className="max-w-md mx-auto">
                                <div className="bg-white rounded-2xl shadow-2xl p-8 text-center">
                                    <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-500 mx-auto mb-6"></div>
                                    <div className="text-xl font-semibold text-gray-700 mb-2">Loading Lusha Data...</div>
                                    <div className="text-gray-500">Analyzing pricing plans and feature evolution...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50">
                        <div className="max-w-md mx-auto text-center">
                            <div className="bg-white rounded-lg shadow-lg p-8">
                                <div className="text-6xl mb-4">❌</div>
                                <div className="text-xl font-semibold text-red-600 mb-4">Processing Error</div>
                                <div className="bg-red-50 border border-red-200 rounded-lg p-4 text-left mb-6">
                                    <div className="text-sm text-red-700">{error}</div>
                                </div>
                                <button
                                    onClick={() => {setError(null); setData(null); loadBillingData();}}
                                    className="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold"
                                >
                                    Reload Data
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                        {/* Header */}
                        <div className="bg-white border-b border-gray-200 sticky top-0 z-50">
                            <div className="max-w-7xl mx-auto px-4 py-4">
                                <div className="flex items-center justify-between">
                                    <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                        🔍 <span>Lusha Feature Analysis</span>
                                        <span className="text-sm bg-yellow-100 text-yellow-700 px-2 py-1 rounded-full font-normal">Open Access</span>
                                        <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full font-normal">v2.0 ✓</span>
                                    </h1>
                                    <div className="flex items-center gap-3">
                                        <div className="text-sm text-green-600 bg-green-50 px-3 py-2 rounded-full font-medium">
                                            ✅ {data.plans.length} Plans • {data.versions.length} Versions
                                        </div>
                                        {user && (
                                            <div className="flex items-center gap-3">
                                                <div className="text-sm text-gray-700">
                                                    <span className="font-medium">{user.name}</span>
                                                    <div className="text-xs text-gray-500">{user.email}</div>
                                                </div>
                                                {user.picture && (
                                                    <img 
                                                        src={user.picture} 
                                                        alt={user.name}
                                                        className="w-8 h-8 rounded-full"
                                                    />
                                                )}
                                                <button
                                                    onClick={handleSignOut}
                                                    className="text-sm text-gray-600 bg-gray-100 px-3 py-2 rounded-full hover:bg-gray-200 font-medium transition-colors"
                                                >
                                                    Sign Out
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="max-w-7xl mx-auto px-4 py-6">
                        {/* Quick Stats */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                            <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-6 rounded-xl border border-blue-200">
                                <div className="text-3xl font-bold text-blue-600">{data.versions.length}</div>
                                <div className="text-sm text-blue-700 font-medium">Versions (≥2.6)</div>
                            </div>
                            <div className="bg-gradient-to-br from-green-50 to-green-100 p-6 rounded-xl border border-green-200">
                                <div className="text-3xl font-bold text-green-600">{data.allPlanNames.length}</div>
                                <div className="text-sm text-green-700 font-medium">Plan Types</div>
                            </div>
                            <div className="bg-gradient-to-br from-purple-50 to-purple-100 p-6 rounded-xl border border-purple-200">
                                <div className="text-3xl font-bold text-purple-600">{data.allFeatures.length}</div>
                                <div className="text-sm text-purple-700 font-medium">Total Features</div>
                            </div>
                            <div className="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-xl border border-orange-200">
                                <div className="text-3xl font-bold text-orange-600">{data.plans.length}</div>
                                <div className="text-sm text-orange-700 font-medium">Plan Configs</div>
                            </div>
                        </div>

                        {/* Controls */}
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">

                            {/* View Mode Toggle */}
                            <div className="mb-6">
                                <label className="block text-sm font-semibold text-gray-700 mb-3">
                                    📊 Analysis View
                                </label>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setViewMode('featureMatrix')}
                                        className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
                                            viewMode === 'featureMatrix' 
                                                ? 'bg-blue-500 text-white' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        📋 Feature Matrix (Features × Versions)
                                    </button>
                                    <button
                                        onClick={() => {
                                            setViewMode('planComparison');
                                            if (!selectedVersion && data.versions.length > 0) {
                                                setSelectedVersion(data.versions[data.versions.length - 1]);
                                            }
                                        }}
                                        className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
                                            viewMode === 'planComparison' 
                                                ? 'bg-green-500 text-white' 
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        🔄 Plan Comparison (Features × Plans)
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                {viewMode === 'featureMatrix' ? (
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            🎯 Select Plan <span className="text-green-600">(Optional - Filters Matrix)</span>
                                        </label>
                                        <select
                                            value={selectedPlan}
                                            onChange={(e) => {
                                                console.log('Plan selection changed:', e.target.value);
                                                setSelectedPlan(e.target.value);
                                            }}
                                            className="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium"
                                        >
                                            <option value="">All Plans</option>
                                            {data.allPlanNames.map(plan => (
                                                <option key={plan} value={plan}>{plan}</option>
                                            ))}
                                        </select>
                                    </div>
                                ) : (
                                    <div>
                                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                                            🎯 Select Version <span className="text-red-600">(Required)</span>
                                        </label>
                                        <select
                                            value={selectedVersion}
                                            onChange={(e) => setSelectedVersion(e.target.value)}
                                            className="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 font-medium"
                                        >
                                            <option value="">Select a Version...</option>
                                            {data.versions.map(version => (
                                                <option key={version} value={version}>
                                                    v{version} ({data.plansByVersion[version]?.length || 0} plans)
                                                </option>
                                            ))}
                                        </select>
                                    </div>
                                )}
                                
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-3">
                                        🔍 Filter Features ({filteredFeatures.length})
                                    </label>
                                    <input
                                        type="text"
                                        value={filterFeatures}
                                        onChange={(e) => setFilterFeatures(e.target.value)}
                                        placeholder="Search features..."
                                        className="w-full p-3 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                    />
                                </div>
                            </div>

                            {viewMode === 'featureMatrix' && (
                                <div>
                                    <label className="block text-sm font-semibold text-gray-700 mb-3">
                                        🎯 Version Selection ({selectedVersions.length} selected)
                                    </label>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={() => setSelectedVersions(data.versions.slice(-5))}
                                            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
                                        >
                                            Latest 5
                                        </button>
                                        <button
                                            onClick={() => setSelectedVersions(data.versions.slice(-10))}
                                            className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium"
                                        >
                                            Latest 10
                                        </button>
                                        <button
                                            onClick={() => setSelectedVersions(data.versions)}
                                            className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium"
                                        >
                                            All ({data.versions.length})
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Main View Container */}
                        <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                            {viewMode === 'featureMatrix' ? (
                                /* Feature Matrix View */
                                <div>
                                    <div className="mb-6">
                                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-3 mb-4">
                                            📋 <span>Feature Matrix:</span> 
                                            <span className="text-blue-600">
                                                {selectedPlan ? `"${selectedPlan}" Plan Analysis` : 'Cross-Version Analysis'}
                                            </span>
                                            <span className="text-sm font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                                {selectedVersions.length} versions • {filteredFeatures.length} features
                                            </span>
                                        </h2>
                                        {selectedPlan && (
                                            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                                <div className="text-sm text-blue-800">
                                                    <strong>📍 Plan-Specific View:</strong> Showing features for the "{selectedPlan}" plan across selected versions. 
                                                    <span className="text-blue-600 ml-1">Clear plan selection to see all features across all plans.</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                {filteredFeatures.length === 0 ? (
                                    <div className="text-center py-12 text-gray-500 bg-gray-50 rounded-lg">
                                        <div className="text-4xl mb-2">🔍</div>
                                        <div>No features match your filter. Try a broader search term.</div>
                                    </div>
                                ) : featureMatrix && featureMatrix.length > 0 ? (
                                        <div className="overflow-x-auto border rounded-xl shadow-sm">
                                            <table className="min-w-full bg-white">
                                                <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
                                                    <tr>
                                                        <th className="sticky left-0 bg-gray-50 px-6 py-4 text-left font-bold text-gray-800 border-r border-gray-200">Feature</th>
                                                        {featureMatrix.map(versionData => (
                                                            <th key={versionData.version} className="px-4 py-4 text-center font-bold text-gray-800 border-r border-gray-200 min-w-[100px]">
                                                                <div className="text-lg">v{versionData.version}</div>
                                                                <div className="text-xs text-gray-600 font-normal">{versionData.planCount} plans</div>
                                                            </th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {filteredFeatures.map(feature => (
                                                        <tr key={feature} className="hover:bg-blue-50 transition-colors">
                                                            <td className="sticky left-0 bg-white hover:bg-blue-50 px-6 py-4 font-semibold text-gray-800 border-r border-gray-200 min-w-[200px]">
                                                                <div className="text-sm">{feature}</div>
                                                            </td>
                                                            {featureMatrix.map(versionData => {
                                                                const hasFeature = versionData.featureMap[feature];
                                                                return (
                                                                    <td key={versionData.version} className={`px-4 py-4 text-center border-r border-gray-200 ${
                                                                        hasFeature ? 'bg-green-100 text-green-800' : 'bg-gray-50 text-gray-400'
                                                                    }`}>
                                                                        <div className="font-bold text-xl">
                                                                            {hasFeature ? '✓' : '—'}
                                                                        </div>
                                                                    </td>
                                                                );
                                                            })}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <div className="text-center py-16 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                                            <div className="text-6xl mb-4">📊</div>
                                            <div className="text-2xl font-bold text-yellow-800 mb-2">Select Versions to Compare</div>
                                            <div className="text-yellow-700">
                                                Choose versions from the controls above to see the feature matrix.
                                                {selectedPlan && <><br />Matrix will show features for the "{selectedPlan}" plan.</>}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                /* Plan Comparison View */
                                <div>
                                    <div className="mb-6">
                                        <h2 className="text-2xl font-bold text-gray-800 flex items-center gap-3 mb-4">
                                            🔄 <span>Plan Comparison:</span> 
                                            <span className="text-green-600">
                                                {selectedVersion ? `Version ${selectedVersion} Analysis` : 'Select Version'}
                                            </span>
                                            {planComparisonMatrix && (
                                                <span className="text-sm font-normal text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                                                    {planComparisonMatrix.plans.length} plans • {filteredFeatures.length} features
                                                </span>
                                            )}
                                        </h2>
                                        {selectedVersion && (
                                            <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                                <div className="text-sm text-green-800">
                                                    <strong>📍 Version-Specific View:</strong> Comparing features across different plans in version {selectedVersion}. 
                                                    <span className="text-green-600 ml-1">Each column shows features available in that specific plan.</span>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {!selectedVersion ? (
                                        <div className="text-center py-16 bg-gradient-to-br from-yellow-50 to-orange-50 rounded-xl border border-yellow-200">
                                            <div className="text-6xl mb-4">🎯</div>
                                            <div className="text-2xl font-bold text-yellow-800 mb-2">Select a Version to Compare Plans</div>
                                            <div className="text-yellow-700">
                                                Choose a pricing version from the dropdown above to see how features differ across plans in that version.
                                            </div>
                                        </div>
                                    ) : filteredFeatures.length === 0 ? (
                                        <div className="text-center py-12 text-gray-500 bg-gray-50 rounded-lg">
                                            <div className="text-4xl mb-2">🔍</div>
                                            <div>No features match your filter. Try a broader search term.</div>
                                        </div>
                                    ) : planComparisonMatrix && planComparisonMatrix.plans.length > 0 ? (
                                        <div className="overflow-x-auto border rounded-xl shadow-sm">
                                            <table className="min-w-full bg-white">
                                                <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
                                                    <tr>
                                                        <th className="sticky left-0 bg-gray-50 px-6 py-4 text-left font-bold text-gray-800 border-r border-gray-200">Feature</th>
                                                        {planComparisonMatrix.plans.map(plan => (
                                                            <th key={plan} className="px-4 py-4 text-center font-bold text-gray-800 border-r border-gray-200 min-w-[120px]">
                                                                <div className="text-lg">{plan}</div>
                                                                <div className="text-xs text-gray-600 font-normal">
                                                                    {planComparisonMatrix.planFeatureMap[plan]?.length || 0} features
                                                                </div>
                                                            </th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {filteredFeatures.map(feature => (
                                                        <tr key={feature} className="hover:bg-green-50 transition-colors">
                                                            <td className="sticky left-0 bg-white hover:bg-green-50 px-6 py-4 font-semibold text-gray-800 border-r border-gray-200 min-w-[200px]">
                                                                <div className="text-sm">{feature}</div>
                                                            </td>
                                                            {planComparisonMatrix.plans.map(plan => {
                                                                const hasFeature = planComparisonMatrix.featureMap[feature]?.[plan];
                                                                return (
                                                                    <td key={plan} className={`px-4 py-4 text-center border-r border-gray-200 ${
                                                                        hasFeature ? 'bg-green-100 text-green-800' : 'bg-gray-50 text-gray-400'
                                                                    }`}>
                                                                        <div className="font-bold text-xl">
                                                                            {hasFeature ? '✓' : '—'}
                                                                        </div>
                                                                    </td>
                                                                );
                                                            })}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    ) : (
                                        <div className="text-center py-16 bg-gradient-to-br from-red-50 to-pink-50 rounded-xl border border-red-200">
                                            <div className="text-6xl mb-4">⚠️</div>
                                            <div className="text-2xl font-bold text-red-800 mb-2">No Plans Found</div>
                                            <div className="text-red-700">
                                                No plans are available for version {selectedVersion}. Please select a different version.
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LushaFeatureAnalysis />);
        
        /* ========== GOOGLE SIGN-IN BUTTON RENDERING - TEMPORARILY DISABLED ==========
         * Uncomment when re-enabling OAuth authentication
         */
        
        // Render Google Sign-In button when component mounts - COMMENTED OUT FOR TEMP ACCESS
        /*
        setTimeout(() => {
            const buttonContainer = document.getElementById('google-signin-button');
            if (buttonContainer && typeof google !== 'undefined' && google.accounts) {
                google.accounts.id.renderButton(
                    buttonContainer,
                    {
                        theme: 'outline',
                        size: 'large',
                        type: 'standard',
                        text: 'signin_with',
                        width: 250
                    }
                );
            }
        }, 500);
        */
    </script>
</body>
</html>